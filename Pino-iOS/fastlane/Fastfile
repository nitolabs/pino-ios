default_platform(:ios)

platform :ios do
  
  before_each do |lane, options|
    ensure_git_status_clean
  end
  
  lane :register_app do
    produce(
      username: 'eskandari.sobhan@gmail.com',
      app_identifier: 'com.pino.fastlane',
      app_name: 'Pino Fastlane',
      language: 'en-US',
      app_version: '1.0',
      sku: '123',
      team_name: 'BIJAN ESKANDARI MANJILI',
      itc_team_name: 'sobhan eskandari'
    )
  end

  lane :get_dev_certs do
    cert(development: true)
    sigh(development: true)
  end

  lane :switch_branch do
    branchName = prompt(text: "Branch Name: ")
    commitMsg  = prompt(text: "Message: ")
    swiftformat(
      swiftversion: "5.5",                                        # Specify swift version (optional)
      config: "../Pino-iOS/.swiftformat",                # Path to configuration file (optional)
      dryrun: false,                                              # Run in dry mode (without actually changing any files) (optional)
    )
    begin
      ensure_git_status_clean
    rescue
      git_add()
      git_commit(path:"*", message: commitMsg)
    end
    git_switch_branch(branch: branchName)
    xcodegen
    cocoapods(use_bundle_exec: false)
  end

  lane :push do
    swiftformat(
      swiftversion: "5.5",                               # Specify swift version (optional)
      config: "../Pino-iOS/.swiftformat",                # Path to configuration file (optional)
      dryrun: false,                                              # Run in dry mode (without actually changing any files) (optional)
    )
    xcbuild
    scan(
      workspace: "Pino-iOS.xcworkspace",
      scheme: "Pino-iOSTests"
    )
    ensure_git_status_clean
    push_to_git_remote
  end
  
  lane :testflight_beta do
    changelog = prompt(text: "What to Test: ")
    xcodegen
    cocoapods(use_bundle_exec: false)
    xcbuild
    scan(
      workspace: "Pino-iOS.xcworkspace",
      scheme: "Pino-iOSTests"
    )
    upload_to_testflight(
      beta_app_feedback_email: "email@email.com",
      beta_app_description: "Pino is a crypto wallet app for iOS devices.",
      demo_account_required: false,
      notify_external_testers: true,
      changelog: changelog,
      username: "eskandari.sobhan@gmail.com",
      app_identifier: "com.krausefx.app",
      api_key: ""
    )
  end

end
