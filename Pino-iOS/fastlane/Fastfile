default_platform(:ios)

platform :ios do
  
  before_each do |lane, options|
    swiftformat(
      swiftversion: "5.5",                               # Specify swift version (optional)
      config: "../Pino-iOS/.swiftformat",                # Path to configuration file (optional)
      dryrun: false,                                     # Run in dry mode (without actually changing any files) (optional)
    )
    begin
      ensure_git_status_clean
    rescue
      commitMsg  = prompt(text: "Message: ")
      git_add()
      git_commit(path:"*", message: commitMsg)
    end
  end

  lane :sync_development do
    match(type: "development")
  end

  lane :get_dev_certs do
    cert(development: true)
    sigh(development: true)
  end

  lane :checkout do
    branchName = prompt(text: "Branch Name: ")
    git_switch_branch(branch: branchName)
    xcodegen(
        spec: "../Pino-iOS/project.yml",
        quiet: true,
        use_cache: true,
    )
    cocoapods(use_bundle_exec: false)
  end

  lane :push do
    scan(
      workspace: "Pino-iOS.xcworkspace",
      scheme: "Pino-iOSTests",
      device: "iPhone 14",
      clean: false
    )
    push_to_git_remote
  end

  lane :pull do 
    branchName = prompt(text: "Branch Name: ")
    sh("git", "pull", "origin", branchName)
    xcodegen(
        spec: "../Pino-iOS/project.yml",
        quiet: true,
        use_cache: true,
    )
    cocoapods(use_bundle_exec: false)
  end
  
  lane :testflight_beta do
    api_key = app_store_connect_api_key(
      duration: 1200, # maximum 1200
    )
    increment_build_number
    changelog = prompt(text: "What to Test: ")
    # scan(
    #   workspace: "Pino-iOS.xcworkspace",
    #   scheme: "Pino-iOSTests",
    #   device: "iPhone 14",
    #   clean: false
    # )
    build_ios_app(
      scheme: "Pino-iOS",
      export_method: "development",
      export_options: {
        provisioningProfiles: {
          "com.aurora.pino.Pino-iOS" => "match Development com.aurora.pino.Pino-iOS",
        }
      }
    )
    match(type: "development", readonly: true)
    upload_to_testflight(
      beta_app_feedback_email: "email@email.com",
      beta_app_description: "Pino is a crypto wallet app for iOS devices.",
      demo_account_required: false,
      notify_external_testers: true,
      changelog: changelog,
      distribute_external: true,
      app_identifier: "com.aurora.pino.Pino-iOS",
      groups: "Pino External Testers",
      api_key: api_key
    )
  end

end
